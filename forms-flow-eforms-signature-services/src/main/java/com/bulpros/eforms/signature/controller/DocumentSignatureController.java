package com.bulpros.eforms.signature.controller;

import java.util.Date;

import javax.validation.Valid;
import javax.xml.bind.DatatypeConverter;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;

import com.bulpros.eforms.signature.model.DataToSignResponse;
import com.bulpros.eforms.signature.model.DocumentToSignRequest;
import com.bulpros.eforms.signature.model.SignedDocumentResponse;
import com.bulpros.eforms.signature.service.SigningService;

import eu.europa.esig.dss.model.DSSDocument;
import eu.europa.esig.dss.model.ToBeSigned;
import eu.europa.esig.dss.spi.DSSUtils;

@Controller
@RequestMapping(value = "/api/signature/document")
public class DocumentSignatureController {
    @Autowired
    private SigningService signingService;
    
    @RequestMapping(value = "/data", method = RequestMethod.POST, produces = MediaType.APPLICATION_JSON_VALUE)
    @ResponseBody
    public DataToSignResponse getDataToSign(@RequestBody @Valid DocumentToSignRequest request) {
//        request.setVisibleSignImage("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");
        request = fillDefaultSignatureParameters(request);
        ToBeSigned   dataToSign = null;
        try {
            dataToSign = signingService.getDataToSign(request);
        } catch (Exception e){
            System.out.println(e.getMessage());
            throw e;
        }
        if (dataToSign == null) {
            return null;
        }

        DataToSignResponse response = new DataToSignResponse();
        response.setDataToSign(DatatypeConverter.printBase64Binary(dataToSign.getBytes()));
        return response;
    }
    
    @RequestMapping(value = "/sign", method = RequestMethod.POST)
    @ResponseBody
    public SignedDocumentResponse sign(@RequestBody @Valid DocumentToSignRequest request) {
//        request.setVisibleSignImage("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");
        request = fillDefaultSignatureParameters(request);

        DSSDocument document = signingService.signDocument(request);

        SignedDocumentResponse signedDocumentResponse = new SignedDocumentResponse(
                document.getName(), 
                document.getMimeType(),
                DSSUtils.toByteArray(document), 
                request.getDigestAlgorithm());
        
        return signedDocumentResponse;
    }
    
    private DocumentToSignRequest fillDefaultSignatureParameters(DocumentToSignRequest request) {
        if (request.getSigningDate() == null) {
            request.setSigningDate(new Date());
        }
        signingService.fillSignatureParametersByDocument(request);

        return request;
    }
}
